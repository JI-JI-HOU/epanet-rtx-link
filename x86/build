# dockerfile for building rtx-link application on x86
FROM ubuntu:xenial

RUN apt-get update && \
	apt-get install -y libsqlite3-dev cmake libiodbc2-dev tdsodbc curl libcurl4-openssl-dev g++ openssl libssl-dev git
RUN apt-get install -y llvm clang
RUN apt-get install -y wget

## build / install boost
ARG boost_version=1.63.0
ARG boost_dir=boost_1_63_0
ENV boost_version ${boost_version}

RUN wget http://downloads.sourceforge.net/project/boost/boost/${boost_version}/${boost_dir}.tar.gz

RUN tar xfz ${boost_dir}.tar.gz \
    && rm ${boost_dir}.tar.gz \
    && cd ${boost_dir} \
    && ./bootstrap.sh \
    && ./b2 cxxflags=-fPIC --without-python --prefix=/usr -j 4 link=static runtime-link=shared install \
    && cd .. && rm -rf ${boost_dir} && ldconfig


WORKDIR /opt

RUN mkdir /opt/src

### install cpprestsdk library
RUN cd /opt/src \
	&& git clone https://github.com/Microsoft/cpprestsdk.git casablanca \
	&& cd casablanca/Release \
	&& mkdir build.release \
	&& cd build.release \
	&& cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=0 -DBUILD_SAMPLES=0 -DBUILD_SHARED_LIBS=0 -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
	&& make \
	&& make install \
	&& cd /opt/src \
	&& rm -rf casablanca

## install sqlite_modern dep
RUN cd /opt/src \
	&& git clone https://github.com/aminroosta/sqlite_modern_cpp.git \
	&& cp -R sqlite_modern_cpp/hdr/* /usr/local/include/ \
	&& cd /opt/src \
	&& rm -rf sqlite_modern_cpp

## install cpprestsdk convenience framework
RUN curl -L -o granada.tar.gz https://github.com/webappsdk/granada/archive/1.56.0.tar.gz \
	&& tar -xzf granada.tar.gz \
	&& cp -R granada-1.56.0/Release/include/granada /usr/local/include \
	&& cd /opt/src \
	&& rm -rf granada

COPY epanet-rtx /opt/epanet-rtx
WORKDIR /opt/epanet-rtx

## build LINK service (rtx-based tier-2 data synchronization service)
RUN cd examples/LINK/service/cmake && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make && make install

